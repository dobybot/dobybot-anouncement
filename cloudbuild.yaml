# # Copyright 2024 Dobybot
# #
# # Licensed under the Apache License, Version 2.0 (the "License");
# # you may not use this file except in compliance with the License.
# # You may obtain a copy of the License at
# #
# #      http://www.apache.org/licenses/LICENSE-2.0
# #
# # Unless required by applicable law or agreed to in writing, software
# # distributed under the License is distributed on an "AS IS" BASIS,
# # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# # See the License for the specific language governing permissions and
# # limitations under the License.

# steps:
#   - id: "Build Container Image"
#     name: "gcr.io/cloud-builders/docker"
#     args:
#       - "build"
#       - "-t"
#       - "${_IMAGE_NAME}"
#       - "-t"
#       - "${_IMAGE_NAME_LATEST}"
#       - "."

#   - id: "Push Container Image"
#     name: "gcr.io/cloud-builders/docker"
#     args:
#       - "push"
#       - "${_IMAGE_NAME}"

#   - id: "Push Latest Tag"
#     name: "gcr.io/cloud-builders/docker"
#     args:
#       - "push"
#       - "${_IMAGE_NAME_LATEST}"

#   - id: "Deploy to Cloud Run"
#     name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
#     entrypoint: /bin/bash
#     args:
#       - "-c"
#       - |
#         gcloud run deploy ${_SERVICE_NAME} \
#           --region ${_REGION} \
#           --image ${_IMAGE_NAME} \
#           --platform managed \
#           --allow-unauthenticated \
#           --port ${_PORT} \
#           --memory ${_MEMORY} \
#           --cpu ${_CPU} \
#           --min-instances ${_MIN_INSTANCES} \
#           --max-instances ${_MAX_INSTANCES} \
#           --timeout ${_TIMEOUT}

# options:
#   logging: CLOUD_LOGGING_ONLY
#   machineType: "E2_HIGHCPU_8"
#   dynamicSubstitutions: true
#   defaultLogsBucketBehavior: REGIONAL_USER_OWNED_BUCKET

# substitutions:
#   _REGION: asia-southeast1
#   _SERVICE_NAME: dobybot-announcement
#   _ARTIFACT_REGISTRY: dobybot-announcement
#   _IMAGE_NAME: gcr.io/${PROJECT_ID}/${_SERVICE_NAME}:${SHORT_SHA}
#   _IMAGE_NAME_LATEST: gcr.io/${PROJECT_ID}/${_SERVICE_NAME}:latest
#   _PORT: "8080"
#   _MEMORY: 256Mi
#   _CPU: "1"
#   _MIN_INSTANCES: "0"
#   _MAX_INSTANCES: "10"
#   _TIMEOUT: 300s

# images:
#   - "${_IMAGE_NAME}"
#   - "${_IMAGE_NAME_LATEST}"

# timeout: "1200s"
steps:
  - id: "Build Container Image"
    name: "gcr.io/cloud-builders/docker"
    args:
      - "build"
      - "-t"
      - "${_IMAGE_NAME}"
      - "-t"
      - "${_IMAGE_NAME_LATEST}"
      - "."

  - id: "Push Container Image"
    name: "gcr.io/cloud-builders/docker"
    args:
      - "push"
      - "${_IMAGE_NAME}"

  - id: "Push Latest Tag"
    name: "gcr.io/cloud-builders/docker"
    args:
      - "push"
      - "${_IMAGE_NAME_LATEST}"

  - id: "Deploy to Cloud Run"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: /bin/bash
    args:
      - "-c"
      - |
        gcloud run deploy ${_SERVICE_NAME} \
          --region ${_REGION} \
          --image ${_IMAGE_NAME} \
          --platform managed \
          --allow-unauthenticated \
          --port ${_PORT} \
          --memory ${_MEMORY} \
          --cpu ${_CPU} \
          --min-instances ${_MIN_INSTANCES} \
          --max-instances ${_MAX_INSTANCES} \
          --timeout ${_TIMEOUT}

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: "E2_HIGHCPU_8"
  dynamicSubstitutions: true
  defaultLogsBucketBehavior: REGIONAL_USER_OWNED_BUCKET

substitutions:
  _REGION: asia-southeast1
  _SERVICE_NAME: dobybot-announcement
  _ARTIFACT_REGISTRY: dobybot-announcement
  # Correct Artifact Registry URI format:
  _IMAGE_NAME: ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY}/${_SERVICE_NAME}:${SHORT_SHA}
  _IMAGE_NAME_LATEST: ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY}/${_SERVICE_NAME}:latest
  _PORT: "8080"
  _MEMORY: 256Mi
  _CPU: "1"
  _MIN_INSTANCES: "0"
  _MAX_INSTANCES: "10"
  _TIMEOUT: 300s

images:
  - "${_IMAGE_NAME}"
  - "${_IMAGE_NAME_LATEST}"

timeout: "1200s"
